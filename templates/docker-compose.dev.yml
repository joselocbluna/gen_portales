# Docker Compose — Desarrollo (Generador de Portales)
# ============================================
# IMPORTANTE: Los puertos del HOST son configurables vía .env
# Los puertos INTERNOS de los contenedores no cambian.
# Esto permite ejecutar múltiples proyectos Docker simultáneamente.
# ============================================
#
# Levantar todo:           docker compose -f docker-compose.dev.yml up
# Levantar en background:  docker compose -f docker-compose.dev.yml up -d
# Con herramientas debug:  docker compose -f docker-compose.dev.yml --profile debug up
# Ver logs:                docker compose -f docker-compose.dev.yml logs -f [servicio]
# Detener:                 docker compose -f docker-compose.dev.yml down

version: "3.9"

services:
  # ============================================
  # FRONTEND — Next.js
  # ============================================
  web:
    container_name: gen_por-web
    build:
      context: ./apps/web
      dockerfile: Dockerfile.dev
    ports:
      - "${WEB_PORT:-4000}:3000"
    volumes:
      - ./apps/web:/app
      - ./packages/shared:/packages/shared
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=http://localhost:${API_PORT:-4001}
      - NEXT_PUBLIC_MINIO_URL=http://localhost:${MINIO_API_PORT:-9002}
      - NEXT_PUBLIC_WS_URL=ws://localhost:${API_PORT:-4001}
    depends_on:
      - api
    networks:
      - generador-net

  # ============================================
  # BACKEND — NestJS
  # ============================================
  api:
    container_name: gen_por-api
    build:
      context: ./apps/api
      dockerfile: Dockerfile.dev
    ports:
      - "${API_PORT:-4001}:3001"
      - "${DEBUG_PORT:-9230}:9229"    # Node.js debugger
    volumes:
      - ./apps/api:/app
      - ./packages/shared:/packages/shared
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - PORT=3001
      # Conexiones internas (usan red Docker, no puertos del host)
      - DATABASE_URL=postgresql://generador:generador_dev@postgres:5432/generador_portales
      - REDIS_URL=redis://redis:6379
      - MINIO_ENDPOINT=minio
      - MINIO_PORT=9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_BUCKET=generador-medios
      - JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-production}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-24h}
      - AI_API_KEY=${AI_API_KEY:-}
      - AI_MODEL=${AI_MODEL:-claude-sonnet-4-5-20250929}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_started
    networks:
      - generador-net

  # ============================================
  # BASE DE DATOS — PostgreSQL 16
  # ============================================
  postgres:
    container_name: gen_por-postgres
    image: postgres:16-alpine
    ports:
      - "${POSTGRES_PORT:-5433}:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-generador}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-generador_dev}
      - POSTGRES_DB=${POSTGRES_DB:-generador_portales}
    volumes:
      - gen_por-pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U generador -d generador_portales"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - generador-net

  # ============================================
  # CACHÉ — Redis 7
  # ============================================
  redis:
    container_name: gen_por-redis
    image: redis:7-alpine
    ports:
      - "${REDIS_PORT:-6380}:6379"
    command: redis-server --appendonly yes
    volumes:
      - gen_por-redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - generador-net

  # ============================================
  # ALMACENAMIENTO — MinIO (S3-compatible)
  # ============================================
  minio:
    container_name: gen_por-minio
    image: minio/minio:latest
    ports:
      - "${MINIO_API_PORT:-9002}:9000"       # API S3
      - "${MINIO_CONSOLE_PORT:-9003}:9001"   # Console web
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
    command: server /data --console-address ":9001"
    volumes:
      - gen_por-minio-data:/data
    networks:
      - generador-net

  # ============================================
  # HERRAMIENTAS DE DESARROLLO (opcionales)
  # Se levantan con: --profile debug
  # ============================================

  # UI para PostgreSQL
  pgadmin:
    container_name: gen_por-pgadmin
    image: dpage/pgadmin4:latest
    ports:
      - "${PGADMIN_PORT:-5051}:80"
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@generador.local
      - PGADMIN_DEFAULT_PASSWORD=admin
    depends_on:
      - postgres
    networks:
      - generador-net
    profiles:
      - debug

  # UI para Redis
  redis-commander:
    container_name: gen_por-redis-commander
    image: rediscommander/redis-commander:latest
    ports:
      - "${REDIS_COMMANDER_PORT:-8082}:8081"
    environment:
      - REDIS_HOSTS=local:redis:6379
    depends_on:
      - redis
    networks:
      - generador-net
    profiles:
      - debug

  # Testing de emails
  maildev:
    container_name: gen_por-maildev
    image: maildev/maildev:latest
    ports:
      - "${MAILDEV_PORT:-1081}:1080"     # Web UI
      - "${MAILDEV_SMTP_PORT:-1026}:1025" # SMTP
    networks:
      - generador-net
    profiles:
      - debug

# ============================================
# VOLÚMENES PERSISTENTES
# Prefijo "gen_por-" para evitar conflicto con otros proyectos
# ============================================
volumes:
  gen_por-pgdata:
    driver: local
  gen_por-redis-data:
    driver: local
  gen_por-minio-data:
    driver: local

# ============================================
# RED
# Nombre único para no interferir con otros proyectos
# ============================================
networks:
  generador-net:
    name: generador-portales-net
    driver: bridge
